stages:          # List of stages for jobs, and their order of execution
  - publish
  - deploy

publish-docker-job:      # This job runs in the publish stage.
  image: docker:stable
  stage: publish  # It only runs when *both* jobs in the test stage complete successfully.
  services:
    - docker:dind
  variables:
    DOCKER_DRIVER: overlay2
    IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  script:
    - echo $CI_REGISTRY $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
    - echo $CERT_PEM > crypto/cert.pem
    - echo $KEY_PEM > crypto/key.pem
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - /bin/sh script/build_docker.sh $IMAGE_TAG
    - docker push $IMAGE_TAG

deploy-job:      # This job runs in the deploy stage.
  image: node:16-bullseye
  before_script:
    - apt-get update
    - apt-get install -y apt-transport-https ca-certificates curl
    - curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg
    - echo "deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main" | tee /etc/apt/sources.list.d/kubernetes.list
    - apt-get update
    - apt-get install -qy kubelet=1.22.2-00 kubectl=1.22.2-00 kubeadm=1.22.2-00 --allow-downgrades --allow-change-held-packages
  stage: deploy  # It only runs when *both* jobs in the test stage complete successfully.
  script:
    - echo "Deploying application on review dev environment..."
    - /bin/bash script/deploy_k8s.sh
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    url: https://${CI_ENVIRONMENT_SLUG}.${fqdn}/.well-known/openid-configuration
    on_stop: stop_review
    kubernetes:
      namespace: development
  rules:
    - if: $CI_MERGE_REQUEST_ID

stop_review:
 stage: deploy
 script:
   - echo "Remove review app"
 environment:
   name: review/$CI_COMMIT_REF_SLUG
   action: stop
 rules:
   - if: $CI_MERGE_REQUEST_ID
     when: manual
